<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- <#assign BASEPATH=request.contextPath /> -->
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <title>模板界面</title>

    <link rel="stylesheet" href="../static/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../static/assets/font-awesome/4.5.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../static/assets/css/ace.min.css" class="ace-main-stylesheet" id="main-ace-style" />

    <script type="text/javascript" src="../static/lib/jquery.min.js"></script>
    <script type="text/javascript" src="../static/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../static/assets/js/ace.min.js"></script>
    <script type="text/javascript" src="../static/js/contextmenu.js"></script>
    <style type="text/css">
        .main{
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .page-content{
            width: 100%;
            height: 95%;
        }
        #breadcrumbs{
            height: 5%;
        }
        .portlet-body{
            width: 100%;
            height: 100%;
            padding: 8px 8px 8px 8px;
            overflow-y: auto;
        }
        .folder-container{
            float: left;
            height: 106px;
            width: 100px;
            margin: 2px 0px 0px 8px;
        }
        .folder-icon{
            background: url(../static/images/file.gif) no-repeat;
            background-size: cover;
            height: 74px;
            width: 80px;
            cursor:pointer;
        }
        .folder-input{
            width: 100px;
            border:none !important;
        }
        .folder-del{
            width: 16px;
            height: 16px;
            margin: 4.5px 0 0 64.5px;
            padding: 0px;
            position:absolute;
            visibility:hidden;
            cursor:pointer;
            background: url("../static/images/delete3.png") no-repeat;
        }
    </style>
</head>
<body class="no-skin">

<div class="main">

    <div class="breadcrumbs ace-save-state" id="breadcrumbs">
        <ul id="filelist" class="breadcrumb">
            <li class="active">
                文件首页
            </li>
        </ul>

        <div class="nav-search" id="nav-search">
            <form class="form-search">
                <span class="input-icon">
                    <input type="text" placeholder="Search ..." class="nav-search-input" id="nav-search-input" autocomplete="off">
                    <i class="ace-icon fa fa-search nav-search-icon"></i>
                </span>
            </form>
        </div>
    </div>

    <div class="page-content">
        <div id="filePanel" class="portlet-body">
        </div>
    </div>


</div>


<div id="context-menu" class="createPanle">
    <ul class="dropdown-menu" role="menu">
        <li><a tabindex="-1" id="createfo">创建文件夹</a></li>
        <li><a tabindex="-1">创建文本文件</a></li>
        <li><a tabindex="-1">取消</a></li>
    </ul>
</div>
</body>



<script type="text/javascript">

(function(w,$, undefined){
    'use strict';
    var version = {
        folder:"<div class='folder-container'><span class='folder-del'></span><div class='folder-icon'></div><input title='%s' type='text' value='' class='folder-input'/></div>",
        a:"<a>%s</a>",
        li:"<li class='active'></li>",
        container:"folder-container",
        dataType:"json"
    };


    $('#filePanel').contextmenu({
        target: '#context-menu',
        before: function (e) {
          e.preventDefault();
          if (e.target.tagName == 'SPAN') {
            e.preventDefault();
            this.closemenu();
            return false;
          }
          return true;
        }
    });


    var paper = function(config, root,context ) {
        var cfg = new domain();
        cfg.url = config['url'];
        cfg.method = config['method'];
        cfg.bean = config['bean'];
        cfg.id = config['id'];
        cfg.nav = config['nav'];

        var obj = getPaperObj();
        obj['config'] = cfg;

        var xx = new domain();
        xx.id = "1";
        xx.name = "aaaa";

        obj.options.linked.push(xx);
        return obj;
    };

    var init = function(options,config,fun){
        var last = options.linked[options.linked.length-1];
        if (typeof fun === 'function') {
            fun(options,config);
        }
        doRequest(config.url,last.id,function(data){
            options.cache[last.id] = data;
            freshenContain(data,config);
            changeActiveLi(options,config,data);
            bindDblclickForFolder(options,config);
        });

    }

    var getInOptions = function(){
        var options = new Object();
        options.linked = new Array();
        options.cache = {};
        return options;
    }

    var getPaperObj = function(){
        var obj = new Object();
        obj['create'] = create;
        obj['update'] = update;
        obj['doNext'] = doNext;
        obj['doHead'] = doHead;
        obj['cutoff'] = cutoff;
        obj['options'] = getInOptions();
        return obj;
    }

    var freshenContain = function(data,config){
        var array = [];
        for(var index = 0; index < data.length;index ++){
             var o = getFolder(data[index]);
             array.push(o.content);
        }
        $("#"+config.id).html(array.join(""));
    }

    var bindDblclickForFolder = function(options,config){
        $(".folder-icon").off("dblclick").on('dblclick',function(){
            var pid = $(this).parent().attr("id");

            var bean = new domain();
            bean.id = pid;
            bean.name = $(this).next().val();

            options.linked.push(bean);//当失败 删除前面一个元素
            init(options,config,doNext);

        });
    }

    var changeActiveLi = function(options,config,data){

        var len  = options.linked.length,bean, $a;

        if (len == 1) {
            var bean = options.linked[len-1];
            $a = sprintf(version.a,bean.name);
            $("#"+config.nav).find("li.active").html($a);
        }else{
            bean = options.linked[len-2];
            $a = sprintf(version.a,bean.name);
            $("#"+config.nav).find("li.active").html('').append($a).removeClass('active');

            var last = options.linked[len-1];
            var $li = $(version.li).html(last.name);
            $("#"+config.nav).append($li.prop("outerHTML"));
        }
        doHead(options,config,bean);
    }

    var getSubLinked = function(options,id){
        var subIndex = 0;
        for(var index = 0; index < options.linked.length; index ++){
            if (options.linked[index].id == id) {
                subIndex = index;
                break;
            }
        }
        options.linked = options.linked.slice(0,subIndex);
    }



    var getFolder = function(bean){
        var name,uuid;
        if (bean) {
            name = bean.name;
            uuid = bean.id;
        }else{    
            var cName='新建文件夹',len = cName.length;
            var files = $("."+version.container);
            name = getNewFileInfo(name,cName,files);
            uuid = guid();
            if (!name) {
                name=cName;
            }
        }
        var folder = sprintf(version.folder,name);
        var $folder = $(folder);
        $folder.attr('id',uuid);
        $folder.find("input").attr('value',name);

        var result = new Object();
        result.content = $folder[0].outerHTML;
        result.bean = {'id':uuid,'name':name};
        return result;
    }

    var getNewFileInfo = function(name,cName,files){

        if(typeof(files)!='undefined' && files.length > 0){
            var same = [];
            for(var i = 0; i < files.length; i++){
                var $_f = $(files[i]);
                var input = $_f.find("input").eq(0);
                var old = input.val();
                if(old.indexOf(cName)>-1){
                    same.push(input);
                }
            }
            if(same.length>0){
                var temp = 0;
                var len = same.length;
                do{
                    if(len-1==0){
                         name = cName+'1';
                    }else{
                        var pre = same[temp];
                        var lst = same[temp+1];
                        if(typeof(lst)=='undefined'){
                            name = cName+(len);
                            break;
                        }else{
                            var start = pre.val().indexOf(cName)+len;
                            var end = pre.val().length;
                            var n1 = pre.val().substr(start, end)==''?0:pre.val().substr(start,end);
                            var n2 = lst.val().substr(lst.val().indexOf(cName)+len, lst.val().length);

                            if((parseInt(n2)-parseInt(n1))!=1){
                                name = cName+(parseInt(n1)+1);
                            }
                        }
                    }
                    temp++;
                }while(temp<len);
            }
        }
        return name;
    }

    //创建
    var create = function(bean,url,callback){
        var f = getFolder();
        var bean = f.bean;
        $("#"+this.config.id).append(f.content);
        bindDblclickForFolder(this.options,this.config);
        url = url || this.config.url;
       // doAjaxRequest(url,bean,callback);
    }
    //更新文件信息
    var update = function(options,config,bean,url){

    }
    //点击头部
    var doHead = function(options,config,bean){
        $("#"+config.nav).find("li.active").prev().find("a").on('click',{'id':bean.id},function(param){
            $(this).parent().nextAll().remove();
            var cacheID = param.data.id;
            var list = options.cache[cacheID];
            freshenContain(list,config);
            bindDblclickForFolder(options,config);
            getSubLinked(options,cacheID);
        });
    }
    //删除
    var cutoff = function(options,config,bean,url){

    }
    var doNext = function(options,config){

    }

    var doAjaxRequest = function(url,bean,callback,type){
        $.ajax({
            type: (type || 'GET'),
            url: url,
            data: bean,
            dataType: version.dataType,
            success: function(data){
                callback(data);
            },
            error:function(e){
                callback(e);
            }
        });


    };

    var doRequest = function(url,pid,callback){

        var array = getDataList([],pid);
        if (typeof callback === 'function') {
            callback(array);
        }
    };


    /**
    *统一的数据接口转换
    */   
/*    var getDataList = function(data){
        data = data || [];
        var arr = [];
        for(var i = 0; i < data.length; i ++){
            var b = new domain();
            b.id = data[i]['id'];
            b.name = data[i]['name'];
            b.level = data[i]['level'];
            b.hidden = data[i]['hidden'];
            b.pid = data[i]['pid'];
            b.desc = data[i]['desc'];
            b.url = data[i]['url'];
            b.createtime = data[i]['createtime'];
            b.children = new Array();
            arr.push(b);
        }
        return arr;
    }*/
    var getDataList = function(data,pid){
        data = data || [];
        var arr = [];
        for(var i = 0; i < 20; i ++){
            var b = new domain();
            b.id = guid();
            b.name = guid();
            b.pid = pid || 0;
            b.children = new Array();
            arr.push(b);
        }
        return arr;
    };

    var sprintf = function (str) {
        var args = arguments,
            flag = true,
            i = 1;

        str = str.replace(/%s/g, function () {
            var arg = args[i++];

            if (typeof arg === 'undefined') {
                flag = false;
                return '';
            }
            return arg;
        });
        return flag ? str : '';
    };
    function guid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
            return v.toString(16);
        }).replace(/-/g,'');
    }
    var domain =  function(){}
    w.paper = paper;
})(window,$) 
var bean = {id:'',userid:'',name:'',level:0,hidden:false,pid:'',desc:'',url:'',createtime:''};

var p = paper({'url':'http://localhost:9000/savename','method':'post','bean':bean,'id':'filePanel','nav':'filelist'});
$("#createfo").click(function(){
    //p['hander']()['create']();
    p.create();
});

</script>
<script type="text/javascript">


</script>
</html>
